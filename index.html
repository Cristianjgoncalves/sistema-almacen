<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>El Almacen del Repostero v107 - Portable</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #f3f4f6; overflow: hidden; }
        .btn-pago { border: 2px solid #e5e7eb; border-radius: 1rem; padding: 10px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; }
        .active-efectivo { border-color: #22c55e; background: #f0fdf4; }
        .active-fiado { border-color: #f59e0b; background: #fffbeb; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex" ondblclick="document.getElementById('buscador').focus()">
    <div id="login-screen" class="fixed inset-0 bg-blue-600 z-[200] flex items-center justify-center p-4">
        <div class="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md text-center">
            <h2 class="text-2xl font-black mb-6 text-blue-600 uppercase italic">EL ALMACEN DEL REPOSTERO</h2>
            <input type="password" id="pass-login" placeholder="CONTRASEÑA" class="w-full p-4 border-2 rounded-2xl mb-4 text-center font-black outline-none focus:border-blue-500">
            <button onclick="intentarLogin()" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-black uppercase shadow-xl hover:bg-blue-700 transition-all">Ingresar</button>
        </div>
    </div>
    <div id="sidebar" class="hidden w-64 bg-white shadow-xl flex flex-col z-20 border-r text-center font-black">
        <div class="p-6 border-b">
            <h1 class="text-xl font-black text-blue-600 uppercase italic leading-tight">EL ALMACEN<br>DEL REPOSTERO</h1>
            <p id="ui-local" class="text-[9px] font-bold text-gray-400 uppercase italic mt-1"></p>
        </div>
        <nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto">
            <button onclick="showSection('pos')" class="w-full flex items-center p-3 hover:bg-blue-50 rounded-xl text-gray-600">
                <i class="fas fa-cash-register mr-3 text-blue-500 w-5"></i> Ventas
            </button>
            <button onclick="showSection('pedidos')" class="w-full flex items-center p-3 hover:bg-blue-50 rounded-xl text-gray-600">
                <i class="fas fa-clipboard-list mr-3 text-purple-500 w-5"></i> Pedidos
            </button>
            <button id="nav-inv" onclick="showSection('inventory')" class="hidden w-full flex items-center p-3 hover:bg-blue-50 rounded-xl text-gray-600">
                <i class="fas fa-boxes mr-3 text-blue-500 w-5"></i> Inventario
            </button>
            <button id="nav-rep" onclick="showSection('reports')" class="hidden w-full flex items-center p-3 hover:bg-blue-50 rounded-xl text-gray-600">
                <i class="fas fa-file-invoice-dollar mr-3 text-blue-500 w-5"></i> Auditoria
            </button>
            <button id="nav-gan" onclick="showSection('ganancias')" class="hidden w-full flex items-center p-3 hover:bg-green-50 rounded-xl text-gray-600">
                <i class="fas fa-hand-holding-usd mr-3 text-green-500 w-5"></i> Ganancias
            </button>
            <button onclick="showSection('totals')" class="w-full flex items-center p-3 hover:bg-blue-50 rounded-xl text-gray-600">
                <i class="fas fa-chart-line mr-3 text-blue-500 w-5"></i> Totales Diarios
            </button>
            <button onclick="showSection('accounts')" class="w-full flex items-center p-3 hover:bg-orange-50 rounded-xl text-orange-600">
                <i class="fas fa-user-clock mr-3 w-5"></i> Cta. Corriente
            </button>
            <button onclick="showSection('weekly')" class="w-full flex items-center p-3 hover:bg-blue-50 rounded-xl text-gray-600">
                <i class="fas fa-list-ol mr-3 text-yellow-500 w-5"></i> Ranking
            </button>
            <button onclick="showSection('config')" class="w-full flex items-center p-3 hover:bg-gray-50 rounded-xl text-gray-500">
                <i class="fas fa-cog mr-3 w-5"></i> Configuracion
            </button>
        </nav>
        <div class="p-4 border-t">
            <button onclick="location.reload()" class="text-[10px] font-black text-red-400 uppercase italic">Salir / Bloquear</button>
        </div>
    </div>
    <div id="main-area" class="hidden flex-1 flex flex-col overflow-hidden text-center font-black">
        <header class="bg-white p-4 border-b flex justify-center">
            <input type="text" id="buscador" oninput="filtro=this.value.toLowerCase();renderVentas()" placeholder="BUSCAR PRODUCTO..." class="w-full max-w-lg p-3 border-2 rounded-2xl font-bold text-center bg-gray-50 outline-none uppercase focus:border-blue-400">
        </header>
        <main id="main-content" class="flex-1 p-6 overflow-y-auto text-center"></main>
    </div>

    <script>
        // Variables Globales y Carga de Datos
        let productos = JSON.parse(localStorage.getItem('productos')) || [];
        let historial = JSON.parse(localStorage.getItem('historial_ventas')) || [];
        let gastos = JSON.parse(localStorage.getItem('gastos')) || [];
        let cuentas = JSON.parse(localStorage.getItem('cuentas_corrientes')) || {};
        let pedidos = JSON.parse(localStorage.getItem('pedidos_repostero')) || [];
        let config = JSON.parse(localStorage.getItem('config_negocio')) || { nombre: "EL ALMACEN DEL REPOSTERO", tel: "", ig: "", fb: "" };
        
        let carrito = [];
        let filtro = "";
        let met = "Efectivo";
      function intentarLogin() {
            const p = document.getElementById('pass-login').value;
            // Mupirata1 es el dueño, 12345 es el empleado
            if (p === "Mupirata1" || p === "12345") {
                if (p === "Mupirata1") {
                    document.getElementById('nav-inv').classList.remove('hidden');
                    document.getElementById('nav-rep').classList.remove('hidden');
                    document.getElementById('nav-gan').classList.remove('hidden');
                }
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('sidebar').classList.remove('hidden');
                document.getElementById('main-area').classList.remove('hidden');
                document.getElementById('ui-local').innerText = config.nombre;
                showSection('pos');
            } else {
                alert("Contraseña Incorrecta");
            }
        }

        function showSection(s) {
            const c = document.getElementById('main-content');
            // Limpiamos el buscador al cambiar de sección para evitar confusiones
            document.getElementById('buscador').value = "";
            filtro = "";

            if (s === 'pos') renderPOS(c);
            else if (s === 'inventory') renderInventory(c);
            else if (s === 'reports') renderReports(c);
            else if (s === 'accounts') renderAccounts(c);
            else if (s === 'totals') renderTotals(c);
            else if (s === 'ganancias') renderGanancias(c);
            else if (s === 'weekly') renderWeekly(c);
            else if (s === 'pedidos') renderPedidos(c);
            else if (s === 'config') renderConfig(c);
        }
      function renderPOS(c) {
            c.innerHTML = `
                <div class="flex gap-4 h-full">
                    <div id="lista-v" class="flex-1 grid grid-cols-3 gap-3 content-start overflow-y-auto px-2"></div>
                    
                    <div class="w-80 bg-white p-6 rounded-3xl shadow-xl flex flex-col border font-black">
                        <div id="cart" class="flex-1 overflow-y-auto space-y-2 mb-4 scrollbar-hide"></div>
                        
                        <input type="text" id="cli-f" placeholder="NOMBRE CLIENTE" class="hidden w-full p-2 border-2 border-orange-400 rounded-xl mb-4 text-center font-black uppercase">
                        
                        <div class="flex justify-between font-black text-3xl mb-4">
                            <span>Total:</span>
                            <span id="t-txt" class="text-blue-600">$0</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mb-4">
                            <div onclick="met='Efectivo';renderPOS(document.getElementById('main-content'))" class="btn-pago ${met === 'Efectivo' ? 'active-efectivo' : ''} font-black text-[10px] uppercase">Efectivo</div>
                            <div onclick="met='Fiado';renderPOS(document.getElementById('main-content'))" class="btn-pago ${met === 'Fiado' ? 'active-fiado' : ''} font-black text-[10px] uppercase">Fiado</div>
                        </div>
                        
                        <button onclick="cobrar(true)" class="w-full bg-blue-600 text-white py-4 rounded-xl font-black uppercase mb-2 shadow-lg hover:bg-blue-700">Ticket</button>
                        <button onclick="cobrar(false)" class="w-full bg-gray-800 text-white py-4 rounded-xl font-black uppercase shadow-lg hover:bg-black">Cobrar</button>
                    </div>
                </div>`;
            
            if (met === 'Fiado') document.getElementById('cli-f').classList.remove('hidden');
            renderVentas();
            updateCart();
        }
      function renderVentas() {
            const f = productos.filter(p => p.nombre.toLowerCase().includes(filtro));
            document.getElementById('lista-v').innerHTML = f.map(p => `
                <div onclick="addCar(${p.id})" class="bg-white p-3 rounded-2xl border-2 hover:border-blue-400 cursor-pointer text-center shadow-sm transition-all active:scale-95">
                    <h3 class="font-black text-[11px] uppercase truncate text-gray-700">${p.nombre}</h3>
                    <p class="text-xl font-black text-blue-900">$${p.precio}</p>
                </div>`).join('');
        }

        function addCar(id) {
            const p = productos.find(x => x.id === id);
            const e = carrito.find(x => x.id === id);
            if (e) e.cant++;
            else carrito.push({ ...p, cant: 1 });
            updateCart();
        }

        function updateCart() {
            const cDiv = document.getElementById('cart');
            if (!cDiv) return;
            cDiv.innerHTML = carrito.map((i, idx) => `
                <div class="flex justify-between items-center bg-gray-50 p-2 rounded-xl text-[10px] border">
                    <span class="truncate w-24 uppercase">${i.nombre}</span>
                    <div class="flex items-center gap-1">
                        <input type="number" step="0.001" value="${i.cant}" onchange="carrito[${idx}].cant=parseFloat(this.value);updateCart()" class="w-14 border text-center rounded-lg font-black">
                        <button onclick="carrito.splice(${idx},1);updateCart()" class="text-red-500 font-black px-1 text-lg">×</button>
                    </div>
                </div>`).join('');
            let total = carrito.reduce((s, i) => s + (i.precio * i.cant), 0);
            document.getElementById('t-txt').innerText = "$" + total.toFixed(2);
        }
      function cobrar(imp) {
            if (!carrito.length) return;
            let total = carrito.reduce((s, i) => s + (i.precio * i.cant), 0);
            let gana = carrito.reduce((s, i) => s + ((i.precio - (i.costo || 0)) * i.cant), 0);
            let cli = "";

            if (met === 'Fiado') {
                cli = document.getElementById('cli-f').value.toUpperCase();
                if (!cli) { alert("POR FAVOR INGRESA EL NOMBRE DEL CLIENTE"); return; }
                cuentas[cli] = (cuentas[cli] || 0) + total;
                localStorage.setItem('cuentas_corrientes', JSON.stringify(cuentas));
            }

            historial.push({
                id: Date.now(),
                fecha: new Date().toLocaleDateString(),
                hora: new Date().toLocaleTimeString(),
                total, ganancia: gana, met, cliente: cli,
                items: [...carrito]
            });
            localStorage.setItem('historial_ventas', JSON.stringify(historial));

            if (imp) {
                const w = window.open('', '_blank');
                w.document.write(`<html><body style="width:230px;text-align:center;font-family:sans-serif;font-weight:bold;">
                    <div style="font-size:14px;margin-bottom:10px;">${config.nombre}</div>
                    <hr>${carrito.map(i => `<div style="font-size:10px;display:flex;justify-content:space-between;"><span>${i.cant}x ${i.nombre}</span><span>$${(i.precio * i.cant).toFixed(2)}</span></div>`).join('')}<hr>
                    <div style="font-size:12px;">TOTAL: $${total.toFixed(2)}</div>
                    <div style="font-size:9px;margin-top:5px;">${met} ${cli}</div><hr>
                    <div style="font-size:8px;">${config.tel ? 'TEL: ' + config.tel : ''}<br>¡GRACIAS POR SU COMPRA!</div>
                    <script>window.print();window.close();<\/script></body></html>`);
            }

            carrito = [];
            met = "Efectivo";
            showSection('pos');
        }
      function renderInventory(c) {
            c.innerHTML = `
                <div class="bg-white p-6 rounded-3xl border mb-6 font-black max-w-2xl mx-auto shadow-sm">
                    <h2 class="mb-4 text-blue-600">NUEVO PRODUCTO</h2>
                    <div class="grid grid-cols-4 gap-2">
                        <input type="text" id="in" placeholder="NOMBRE" class="border-2 p-3 rounded-xl uppercase outline-none focus:border-blue-400">
                        <input type="number" id="ic" placeholder="COSTO" class="border-2 p-3 rounded-xl outline-none">
                        <input type="number" id="ip" placeholder="VENTA" class="border-2 p-3 rounded-xl outline-none">
                        <button onclick="saveP()" class="bg-blue-600 text-white rounded-xl font-black hover:bg-blue-700">GUARDAR</button>
                    </div>
                </div>
                <div id="l-inv" class="space-y-2 max-w-2xl mx-auto"></div>`;
            renderInvList();
        }

        function renderInvList() {
            document.getElementById('l-inv').innerHTML = productos.map((p, idx) => `
                <div class="bg-white p-4 rounded-xl border flex justify-between font-black uppercase text-xs items-center shadow-sm">
                    <span class="w-1/2 text-left">${p.nombre}</span>
                    <div class="flex gap-4 items-center">
                        <span class="text-gray-400">C:$${p.costo || 0}</span>
                        <input type="number" value="${p.precio}" onchange="productos[${idx}].precio=parseFloat(this.value);localStorage.setItem('productos',JSON.stringify(productos))" class="w-20 border-2 rounded-lg p-1 text-center font-black focus:border-blue-400">
                        <button onclick="if(confirm('¿BORRAR?')){productos.splice(${idx},1);localStorage.setItem('productos',JSON.stringify(productos));renderInvList()}" class="text-red-300 ml-2">X</button>
                    </div>
                </div>`).join('');
        }

        function saveP() {
            let n = document.getElementById('in').value, c = document.getElementById('ic').value, p = document.getElementById('ip').value;
            if (n && p) {
                productos.push({ id: Date.now(), nombre: n.toUpperCase(), costo: parseFloat(c || 0), precio: parseFloat(p) });
                localStorage.setItem('productos', JSON.stringify(productos));
                renderInvList();
                document.getElementById('in').value = ""; document.getElementById('ic').value = ""; document.getElementById('ip').value = "";
            }
        }

        function renderReports(c) {
            const h = historial.filter(v => v.fecha === new Date().toLocaleDateString());
            c.innerHTML = `
                <h2 class="text-2xl font-black text-blue-600 mb-6 text-center">AUDITORIA HOY</h2>
                <div class="space-y-2 max-w-xl mx-auto">
                    ${h.slice().reverse().map(v => `
                        <div class="bg-white p-4 rounded-xl border flex justify-between items-center font-black text-xs shadow-sm">
                            <span class="text-left">${v.hora}<br>${v.met} ${v.cliente}</span>
                            <div class="flex items-center">
                                <b class="text-lg mr-4">$${v.total.toFixed(2)}</b>
                                <button onclick="borrarV(${v.id})" class="text-red-400 text-lg">×</button>
                            </div>
                        </div>`).join('')}
                </div>`;
        }

        function borrarV(id) {
            if (confirm("¿ANULAR ESTA VENTA?")) {
                historial = historial.filter(v => v.id !== id);
                localStorage.setItem('historial_ventas', JSON.stringify(historial));
                showSection('reports');
            }
        }
      function renderTotals(c) {
            const f = new Date().toLocaleDateString();
            const vH = historial.filter(v => v.fecha === f && !v.cliente.includes('(PAGO)')).reduce((s, v) => s + v.total, 0);
            const pH = historial.filter(v => v.fecha === f && v.cliente.includes('(PAGO)')).reduce((s, v) => s + v.total, 0);
            const gH = gastos.filter(g => g.fecha === f).reduce((s, g) => s + g.monto, 0);

            c.innerHTML = `
                <h2 class="text-2xl font-black text-blue-600 mb-6 uppercase text-center">TOTALES DIARIOS</h2>
                <div class="grid grid-cols-2 gap-4 mb-6 max-w-lg mx-auto">
                    <div class="bg-white p-6 rounded-3xl border shadow-xl">Ventas: <p class="text-2xl text-blue-600">$${vH.toFixed(2)}</p></div>
                    <div class="bg-white p-6 rounded-3xl border shadow-xl">Entregas: <p class="text-2xl text-green-600">$${pH.toFixed(2)}</p></div>
                    <div class="bg-white p-6 rounded-3xl border shadow-xl col-span-2">
                        Gastos: <p class="text-2xl text-red-500">$${gH.toFixed(2)}</p>
                        <button onclick="addGasto()" class="bg-red-500 text-white px-6 py-2 rounded-xl font-black mt-2 uppercase text-[10px] shadow-md hover:bg-red-600">+ CARGAR GASTO</button>
                    </div>
                </div>
                <div class="mt-4 p-4 bg-white rounded-2xl border text-left max-w-lg mx-auto">
                    <h3 class="font-black text-gray-400 text-[10px] uppercase mb-2">Detalle de Gastos (Hoy):</h3>
                    <div class="space-y-1">
                        ${gastos.filter(g => g.fecha === f).map(g => `
                            <div class="flex justify-between items-center text-[10px] font-black border-b pb-1">
                                <span>${g.desc}</span>
                                <div class="flex items-center gap-3"><span class="text-red-500">$${g.monto.toFixed(2)}</span><button onclick="borrarGasto(${g.id})" class="text-gray-300 hover:text-red-500">×</button></div>
                            </div>`).join('')}
                    </div>
                </div>
                <div class="mt-8"><h3 class="font-black text-green-600 text-5xl">CAJA: $${(vH + pH - gH).toFixed(2)}</h3></div>`;
        }

        function addGasto() {
            let d = prompt("CONCEPTO DEL GASTO:");
            let m = prompt("MONTO $:");
            if (d && m && !isNaN(parseFloat(m))) {
                gastos.push({ id: Date.now(), fecha: new Date().toLocaleDateString(), desc: d.toUpperCase(), monto: parseFloat(m) });
                localStorage.setItem('gastos', JSON.stringify(gastos));
                showSection('totals');
            }
        }

        function borrarGasto(id) {
            if (confirm("¿BORRAR GASTO?")) {
                gastos = gastos.filter(g => g.id !== id);
                localStorage.setItem('gastos', JSON.stringify(gastos));
                showSection('totals');
            }
        }
      function renderAccounts(c) {
            c.innerHTML = `<h2 class="text-2xl font-black text-orange-600 mb-6 text-center uppercase">CUENTAS CORRIENTES</h2>
                <div id="pago-form" class="hidden mb-6 bg-blue-50 p-6 rounded-2xl border-2 border-blue-200 max-w-sm mx-auto">
                    <input type="number" id="m-pago" placeholder="MONTO $" class="p-3 rounded-xl border-2 w-full mb-2 text-center font-black">
                    <button onclick="confPago()" class="bg-blue-600 text-white w-full py-3 rounded-xl font-black">CONFIRMAR ENTREGA</button>
                </div>
                <div class="grid grid-cols-2 gap-4 max-w-2xl mx-auto">${Object.entries(cuentas).map(([n, d]) => d > 0 ? `<div class="bg-white p-6 rounded-3xl border shadow-sm text-center font-black"><h3 class="uppercase text-blue-900">${n}</h3><p class="text-3xl text-red-600 my-2">$${d.toFixed(2)}</p><button onclick="document.getElementById('pago-form').classList.remove('hidden');window.cliP='${n}'" class="bg-green-500 text-white px-4 py-2 rounded-xl text-xs uppercase shadow-md">ENTREGA PAGO</button></div>` : '').join('')}</div>`;
        }

        function confPago() {
            let m = parseFloat(document.getElementById('m-pago').value), n = window.cliP;
            if (!isNaN(m)) {
                historial.push({ id: Date.now(), fecha: new Date().toLocaleDateString(), hora: new Date().toLocaleTimeString(), total: m, ganancia: m, met: 'Efectivo', cliente: n + ' (PAGO)' });
                cuentas[n] -= m;
                localStorage.setItem('cuentas_corrientes', JSON.stringify(cuentas));
                localStorage.setItem('historial_ventas', JSON.stringify(historial));
                showSection('accounts');
            }
        }

        function renderGanancias(c) {
            const f = new Date().toLocaleDateString(), gH = historial.filter(v => v.fecha === f).reduce((s, v) => s + v.ganancia, 0);
            c.innerHTML = `<h2 class="text-2xl font-black text-green-600 mb-6 uppercase text-center">GANANCIAS</h2><div class="bg-white p-10 rounded-[3rem] border shadow-xl text-center max-w-sm mx-auto"><p class="text-gray-400 uppercase text-xs">Hoy</p><p class="text-6xl text-green-600">$${gH.toFixed(2)}</p></div>`;
        }

        function renderConfig(c) {
            c.innerHTML = `<div class="bg-white p-10 rounded-3xl border max-w-md mx-auto text-center font-black"><h2>CONFIGURACION</h2><input id="cn" value="${config.nombre}" class="w-full border-2 p-3 rounded-xl mb-2 uppercase text-center font-black"><input id="ct" placeholder="TEL" value="${config.tel}" class="w-full border-2 p-3 rounded-xl mb-2 text-center font-black"><button onclick="config.nombre=document.getElementById('cn').value.toUpperCase();config.tel=document.getElementById('ct').value;localStorage.setItem('config_negocio',JSON.stringify(config));location.reload()" class="bg-blue-600 text-white w-full py-4 rounded-xl font-black">GUARDAR</button></div>`;
        }

        function renderWeekly(c) { c.innerHTML = `<h2 class="text-3xl font-black mb-8 uppercase text-center">Ranking</h2><p class="text-gray-400">Próximamente versión completa.</p>`; }
        function renderPedidos(c) { c.innerHTML = `<h2 class="text-3xl font-black mb-8 uppercase text-center">Pedidos</h2><p class="text-gray-400">Próximamente versión completa.</p>`; }
    </script>
</body>
</html>

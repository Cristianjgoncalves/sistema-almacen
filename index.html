<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>El Almacén del Repostero v103</title><script src="https://cdn.tailwindcss.com"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"><style>@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');body{font-family:'Inter',sans-serif;background:#f3f4f6;overflow:hidden}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-thumb{background:#3b82f6;border-radius:10px}.btn-pago{border:2px solid #e5e7eb;transition:0.2s;cursor:pointer;border-radius:1.5rem;padding:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;height:75px}.active-efectivo{border-color:#22c55e!important;background:#f0fdf4!important}.active-transferencia{border-color:#3b82f6!important;background:#eff6ff!important}.active-tarjeta{border-color:#ef4444!important;background:#fef2f2!important}.active-fiado{border-color:#f59e0b!important;background:#fffbeb!important}.input-cantidad{width:100px;height:45px;border:2px solid #3b82f6;text-align:center;font-weight:900;border-radius:12px;outline:none}.img-prod{width:100%;height:80px;object-fit:cover;border-radius:1rem;margin-bottom:5px}</style></head><body class="h-screen flex" ondblclick="forzarFoco()"><div id="login-screen" class="fixed inset-0 bg-blue-600 z-[200] flex items-center justify-center p-4"><div class="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md text-center"><h2 class="text-2xl font-black mb-6 italic uppercase text-blue-600">EL ALMACÉN DEL REPOSTERO</h2><div class="space-y-4"><input type="text" id="user-input" placeholder="USUARIO" class="w-full p-4 bg-gray-50 border-2 rounded-2xl font-black text-center outline-none focus:border-blue-500 uppercase"><input type="password" id="pass-login" placeholder="CONTRASEÑA" class="w-full p-4 bg-gray-50 border-2 rounded-2xl font-black text-center outline-none focus:border-blue-500"><button onclick="intentarLogin()" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-black uppercase shadow-xl hover:bg-blue-700 transition-all text-xs">Ingresar</button></div></div></div><div id="sidebar" class="hidden w-72 bg-white shadow-xl flex flex-col z-20 border-r text-center"><div class="p-6 border-b"><img id="app-logo" src="OIP.webp" class="mx-auto mb-4 w-32 h-32 rounded-full shadow-lg object-cover border-2 border-blue-100"><h1 class="text-xl font-black text-blue-600 uppercase italic leading-tight">EL ALMACÉN<br>DEL REPOSTERO</h1><p id="ui-nombre-local" class="text-[9px] font-bold text-gray-400 uppercase italic mt-1"></p></div><nav class="flex-1 px-4 py-4 space-y-1 overflow-y-auto"><button onclick="showSection('pos')" class="w-full flex items-center p-4 hover:bg-blue-50 rounded-2xl font-bold text-gray-600"><i class="fas fa-cash-register mr-3 text-blue-500"></i> Ventas</button><button onclick="showSection('pedidos')" class="w-full flex items-center p-4 hover:bg-blue-50 rounded-2xl font-bold text-gray-600"><i class="fas fa-clipboard-list mr-3 text-purple-500"></i> Pedidos</button><button id="nav-inventory" onclick="showSection('inventory')" class="w-full flex items-center p-4 hover:bg-blue-50 rounded-2xl font-bold text-gray-600 hidden"><i class="fas fa-boxes mr-3 text-blue-500"></i> Inventario</button><button id="nav-reports" onclick="showSection('reports')" class="w-full flex items-center p-4 hover:bg-blue-50 rounded-2xl font-bold text-gray-600 hidden"><i class="fas fa-file-invoice-dollar mr-3 text-blue-500"></i> Auditoría</button><button id="nav-ganancias" onclick="showSection('ganancias')" class="w-full flex items-center p-4 hover:bg-green-50 rounded-2xl font-bold text-gray-600 hidden"><i class="fas fa-hand-holding-usd mr-3 text-green-500"></i> Ganancias</button><button onclick="showSection('totals')" class="w-full flex items-center p-4 hover:bg-blue-50 rounded-2xl font-bold text-gray-600"><i class="fas fa-chart-line mr-3 text-blue-500"></i> Totales Diarios</button><button onclick="showSection('accounts')" class="w-full flex items-center p-4 hover:bg-blue-50 rounded-2xl font-bold text-gray-600"><i class="fas fa-user-clock mr-3 text-orange-500"></i> Cta. Corriente</button><button onclick="showSection('weekly')" class="w-full flex items-center p-4 hover:bg-blue-50 rounded-2xl font-bold text-gray-600"><i class="fas fa-list-ol mr-3 text-yellow-500"></i> Ranking</button><button id="nav-config" onclick="showSection('config')" class="w-full flex items-center p-4 hover:bg-blue-50 rounded-2xl font-bold text-gray-600 hidden"><i class="fas fa-cog mr-3 text-gray-500"></i> Configuración</button></nav><div class="p-4 border-t text-center"><button onclick="location.reload()" class="text-[10px] font-black text-red-400 uppercase italic">Salir</button><div id="reloj" class="text-[10px] font-black text-blue-900 mt-2"></div></div></div><div id="main-area" class="hidden flex-1 flex flex-col overflow-hidden text-center"><header class="bg-white p-6 shadow-sm border-b flex justify-center"><input type="text" id="buscador" oninput="filtroActual=this.value.toLowerCase();actualizarVentas()" placeholder="¿Qué buscamos hoy?" class="w-full max-w-lg p-3 border-2 rounded-2xl font-bold text-center bg-gray-50 outline-none focus:border-blue-500 uppercase"></header><main id="main-content" class="flex-1 p-8 overflow-y-auto text-center"></main></div>
<script>
let currentUserRole="",isOwner=false,productos=JSON.parse(localStorage.getItem('productos'))||[],historialVentas=JSON.parse(localStorage.getItem('historial_ventas'))||[],gastos=JSON.parse(localStorage.getItem('gastos'))||[],cuentasCorrientes=JSON.parse(localStorage.getItem('cuentas_corrientes'))||{},cajasIniciales=JSON.parse(localStorage.getItem('cajas_iniciales'))||{},pedidos=JSON.parse(localStorage.getItem('pedidos_repostero'))||[],logoGuardado=localStorage.getItem('app_logo_base64')||"OIP.webp",configNegocio=JSON.parse(localStorage.getItem('config_negocio'))||{nombre:"EL ALMACÉN DEL REPOSTERO",dir1:"Sarmiento 2201",dir2:"Marcos Paz",tel:"",ig:"",fb:""},carrito=[],filtroActual="",filtroInv="",metodoActual="Efectivo",tempImgProd="";
const fmtNum=n=>parseFloat(parseFloat(n).toFixed(3));
function forzarFoco(){const b=document.getElementById('buscador');if(b)b.focus()}
function intentarLogin(){const u=document.getElementById('user-input').value,p=document.getElementById('pass-login').value;if(u==="admin"&&(p==="Mupirata1"||p==="12345")){isOwner=(p==="Mupirata1");currentUserRole="admin";entrarAlPrograma()}else alert("Error")}
function entrarAlPrograma(){document.getElementById('login-screen').classList.add('hidden');document.getElementById('sidebar').classList.remove('hidden');document.getElementById('main-area').classList.remove('hidden');if(isOwner){document.getElementById('nav-inventory').classList.remove('hidden');document.getElementById('nav-reports').classList.remove('hidden');document.getElementById('nav-ganancias').classList.remove('hidden');document.getElementById('nav-config').classList.remove('hidden')}document.getElementById('ui-nombre-local').innerText=configNegocio.nombre;document.getElementById('app-logo').src=logoGuardado;showSection('pos')}
function showSection(n){const c=document.getElementById('main-content');if(n==='pos')renderPOS(c);else if(n==='pedidos')renderPedidos(c);else if(n==='inventory')renderInventory(c);else if(n==='reports')renderReports(c);else if(n==='totals')renderDailyTotals(c);else if(n==='accounts')renderAccounts(c);else if(n==='weekly')renderWeeklyRanking(c);else if(n==='config')renderConfig(c);else if(n==='ganancias')renderGanancias(c)}

// COBRAR Y TICKET (CON REDES SOCIALES)
function cobrar(imp){
    if(!carrito.length)return;
    const t=carrito.reduce((s,i)=>s+(i.precio*i.cantidad),0);
    const pCon=parseFloat(document.getElementById('pago-con').value);
    let vuel=0; if(!isNaN(pCon)){if(pCon<t){alert("Monto insuficiente");return}vuel=pCon-t}
    let cli=""; if(metodoActual==='Fiado'){cli=document.getElementById('fiado-cli').value.toUpperCase();if(!cli){alert("PONER NOMBRE");return}cuentasCorrientes[cli]=fmtNum((cuentasCorrientes[cli]||0)+t);localStorage.setItem('cuentas_corrientes',JSON.stringify(cuentasCorrientes))}
    historialVentas.push({id:Date.now(),fecha:new Date().toLocaleDateString(),hora:new Date().toLocaleTimeString(),total:t,ganancia:carrito.reduce((s,i)=>s+(i.precio-i.costo)*i.cantidad,0),metodo:metodoActual,cliente:cli,itemsDetallados:carrito.map(i=>({id:i.id,nombre:i.nombre,cantidad:i.cantidad,precio:i.precio,costo:i.costo}))});
    carrito.forEach(item=>{const p=productos.find(x=>x.id===item.id);if(p)p.stock=fmtNum(p.stock-item.cantidad)});
    localStorage.setItem('historial_ventas',JSON.stringify(historialVentas));localStorage.setItem('productos',JSON.stringify(productos));
    if(imp)imprimirTicket(t,cli,pCon,vuel);
    carrito=[]; metodoActual="Efectivo"; showSection('pos');
}
function imprimirTicket(t,cli,pCon,vuel){
    const w=window.open('','_blank');
    w.document.write(`<html><body style="font-family:sans-serif;width:230px;text-align:center;">
    <img src="${logoGuardado}" style="width:70px;height:70px;border-radius:50%;object-fit:cover;margin-bottom:5px;"><br>
    <b style="font-size:14px;text-transform:uppercase;">${configNegocio.nombre}</b><hr>
    <table style="width:100%;font-size:10px;text-align:left;">${carrito.map(i=>`<tr><td>${i.cantidad}</td><td>${i.nombre}</td><td>$${fmtNum(i.precio*i.cantidad)}</td></tr>`).join('')}</table><hr>
    <b>TOTAL: $${fmtNum(t)}</b><br>${!isNaN(pCon)?`Paga con: $${fmtNum(pCon)}<br>Vuelto: $${fmtNum(vuel)}<br>`:''}<span style="font-size:10px;">${metodoActual} ${cli||''}</span><hr>
    <div style="font-size:9px;">${configNegocio.tel?'Tel:'+configNegocio.tel:''}<br>${configNegocio.ig?'IG:'+configNegocio.ig:''}<br>${configNegocio.fb?'FB:'+configNegocio.fb:''}<br>¡GRACIAS POR ELEGIRNOS!</div>
    <script>window.print();window.close();<\/script></body></html>`);
}

// CTA CORRIENTE (PAGOS ARREGLADOS)
function renderAccounts(c){
    c.innerHTML=`<h2 class="text-3xl font-black text-orange-500 mb-8 uppercase italic text-center">Cuentas Corrientes</h2>
    <div id="pago-fiado-form" class="bg-blue-50 p-6 rounded-[2rem] mb-6 border-2 border-blue-200 hidden">
    <input type="number" id="pago-monto" placeholder="MONTO $" class="p-2 rounded-xl border text-center font-black outline-none w-full mb-2">
    <button onclick="confirmarPagoFiado()" class="bg-blue-500 text-white py-2 rounded-xl font-black w-full uppercase">Confirmar Pago</button></div>
    <div class="grid grid-cols-3 gap-6">${Object.entries(cuentasCorrientes).map(([n,d])=>`<div class="bg-white p-8 rounded-[3rem] border shadow-sm text-center">
    <h3 class="font-black text-blue-900 text-xl uppercase">${n}</h3><p class="text-4xl font-black text-red-600 mb-6">$${fmtNum(d)}</p>
    <button onclick="document.getElementById('pago-fiado-form').classList.remove('hidden');window.targetCliPago='${n}'" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-xs">Entrega Pago</button></div>`).join('')}</div>`;
}
function confirmarPagoFiado(){
    const p=parseFloat(document.getElementById('pago-monto').value),n=window.targetCliPago;
    if(!isNaN(p)){
        historialVentas.push({id:Date.now(),fecha:new Date().toLocaleDateString(),hora:new Date().toLocaleTimeString(),total:p,ganancia:p,metodo:'Efectivo',cliente:n+' (ENTREGA)',itemsDetallados:[]});
        cuentasCorrientes[n]=fmtNum(cuentasCorrientes[n]-p); if(cuentasCorrientes[n]<0)cuentasCorrientes[n]=0;
        localStorage.setItem('cuentas_corrientes',JSON.stringify(cuentasCorrientes)); localStorage.setItem('historial_ventas',JSON.stringify(historialVentas));
        showSection('accounts');
    }
}

// ARREGLO DE AUDITORÍA (NO SE CONGELA)
function anulV(id){
    if(window.confirm("¿Anular venta?")){
        const v=historialVentas.find(x=>x.id===id);
        if(v.metodo==='Fiado')cuentasCorrientes[v.cliente]-=v.total;
        v.itemsDetallados.forEach(i=>{const p=productos.find(x=>x.id===i.id); if(p)p.stock=fmtNum(p.stock+i.cantidad)});
        historialVentas=historialVentas.filter(x=>x.id!==id);
        localStorage.setItem('historial_ventas',JSON.stringify(historialVentas));localStorage.setItem('productos',JSON.stringify(productos));
        showSection('reports');
    }
}

// CONFIGURACIÓN (CON REDES SOCIALES)
function renderConfig(c){
    c.innerHTML=`<div class="max-w-2xl mx-auto bg-white p-12 rounded-[3.5rem] border text-center shadow-xl font-black"><h2 class="text-3xl font-black uppercase mb-10 text-blue-600 italic">CONFIGURACIÓN</h2><div class="space-y-6">
    <input type="text" id="cfg-n" value="${configNegocio.nombre}" class="w-full p-4 border-2 rounded-2xl text-center uppercase">
    <input type="text" id="cfg-t" placeholder="TEL" value="${configNegocio.tel||''}" class="p-4 border-2 rounded-2xl text-center w-full">
    <input type="text" id="cfg-i" placeholder="INSTAGRAM" value="${configNegocio.ig||''}" class="p-4 border-2 rounded-2xl text-center w-full">
    <input type="text" id="cfg-f" placeholder="FACEBOOK" value="${configNegocio.fb||''}" class="p-4 border-2 rounded-2xl text-center w-full">
    <button onclick="saveCfg()" class="w-full bg-blue-600 text-white py-5 rounded-[2rem] font-black uppercase">Guardar Cambios</button></div></div>`;
}
function saveCfg(){
    configNegocio.nombre=document.getElementById('cfg-n').value.toUpperCase();
    configNegocio.tel=document.getElementById('cfg-t').value;
    configNegocio.ig=document.getElementById('cfg-i').value;
    configNegocio.fb=document.getElementById('cfg-f').value;
    localStorage.setItem('config_negocio',JSON.stringify(configNegocio)); location.reload();
}

// LAS DEMÁS FUNCIONES (VENTAS, INVENTARIO, ETC.)
function renderPOS(c){
    c.innerHTML=`<div class="flex gap-8 h-full"><div id="lista-ventas" class="flex-1 grid grid-cols-3 gap-4 content-start overflow-y-auto"></div>
    <div class="w-[450px] bg-white rounded-[3rem] shadow-2xl p-8 flex flex-col border font-black">
    <div id="cart-list" class="flex-1 overflow-y-auto space-y-3"></div>
    <div class="pt-6 border-t-2 border-dashed mt-auto">
    <input type="number" id="pago-con" placeholder="¿Paga con cuánto?" class="w-full p-2 border-2 rounded-xl text-center font-black outline-none mb-4">
    <div id="fiado-nombre-div" class="hidden mb-4"><input type="text" id="fiado-cli" placeholder="NOMBRE DEL CLIENTE" class="w-full p-2 border-2 border-orange-400 rounded-xl text-center uppercase font-black"></div>
    <div class="flex justify-between items-center mb-6 font-black"><span class="text-xs uppercase text-gray-400 font-black">Total</span><span id="total-txt" class="text-5xl font-black text-blue-900">$0</span></div>
    <div class="grid grid-cols-4 gap-2 mb-6"><button onclick="setMet('Efectivo')" id="btn-Efectivo" class="btn-pago active-efectivo font-black">Efectivo</button>
    <button onclick="setMet('Transferencia')" id="btn-Transferencia" class="btn-pago">Transf.</button><button onclick="setMet('Tarjeta')" id="btn-Tarjeta" class="btn-pago">Tarjeta</button><button onclick="setMet('Fiado')" id="btn-Fiado" class="btn-pago">Fiado</button></div>
    <div class="grid grid-cols-2 gap-4"><button onclick="cobrar(true)" class="bg-blue-600 text-white py-5 rounded-[2rem] font-black uppercase text-xs">Ticket</button><button onclick="cobrar(false)" class="bg-gray-800 text-white py-5 rounded-[2rem] font-black uppercase text-xs">Cobrar</button></div></div></div></div>`;
    actualizarVentas(); renderCart();
}
function actualizarVentas(){const f=productos.filter(p=>p.nombre.toLowerCase().includes(filtroActual)); const l=document.getElementById('lista-ventas'); if(!l)return; l.innerHTML=f.map(p=>`<div onclick="addCar(${p.id})" class="bg-white p-4 rounded-3xl border-2 hover:border-blue-400 cursor-pointer text-center h-fit shadow-sm"><h3 class="font-black text-[10px] uppercase truncate">${p.nombre}</h3><p class="text-xl font-black text-gray-900">$${p.precio}</p><p class="text-[9px] text-gray-300 italic font-bold">Stock: ${p.stock}</p></div>`).join('')}
function renderInventory(c){c.innerHTML=`<div class="bg-white p-10 rounded-[3rem] border shadow-xl mb-6"><div class="grid grid-cols-5 gap-4"><input type="text" id="i-n" placeholder="NOMBRE" class="p-4 border-2 rounded-2xl text-center uppercase font-black"><input type="number" id="i-c" placeholder="COSTO" class="p-4 border-2 rounded-2xl text-center"><input type="number" id="i-p" placeholder="VENTA" class="p-4 border-2 rounded-2xl text-center"><input type="number" id="i-s" placeholder="STOCK" class="p-4 border-2 rounded-2xl text-center"><button onclick="saveP()" class="bg-blue-600 text-white rounded-2xl font-black uppercase">Guardar</button></div></div><div id="lista-inv" class="space-y-2"></div>`; actualizarTablaInv()}
function actualizarTablaInv(){const l=document.getElementById('lista-inv'); if(!l)return; l.innerHTML=productos.map((p,ri)=>`<div class="bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm"><div class="uppercase font-black text-sm">${p.nombre}</div><div class="flex gap-4"><input type="number" value="${p.precio}" onchange="productos[${ri}].precio=this.value;localStorage.setItem('productos',JSON.stringify(productos))" class="w-20 text-center bg-blue-50 p-2 rounded-lg font-black"><button onclick="productos.splice(${ri},1);localStorage.setItem('productos',JSON.stringify(productos));actualizarTablaInv()" class="text-red-300 text-2xl"><i class="fas fa-trash"></i></button></div></div>`).join('')}
function saveP(){const n=document.getElementById('i-n').value,c=parseFloat(document.getElementById('i-c').value),p=parseFloat(document.getElementById('i-p').value),s=parseFloat(document.getElementById('i-s').value); if(n){productos.push({id:Date.now(),nombre:n.toUpperCase(),costo:c||0,precio:p||0,stock:s||0});localStorage.setItem('productos',JSON.stringify(productos));showSection('inventory')}}
setInterval(()=>document.getElementById('reloj').innerText=new Date().toLocaleString(),1000);
</script></body></html>
